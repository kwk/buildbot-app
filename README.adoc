= Your GitHub App that talks to Buildbot
Konrad Kleine;
:toc: left
:toclevels: 5
:showtitle:
:experimental:
:sectnums:
:stem:
:sectlinks:
:listing-caption: Listing
:sectanchors:
// :icons: font
:source-highlighter: pygments

// // See https://gist.github.com/dcode/0cfbf2699a1fe9b46ff04c41721dda74#admonitions
// ifdef::env-github[]
// :tip-caption: :bulb:
// :note-caption: :information_source:
// :important-caption: :heavy_exclamation_mark:
// :caution-caption: :fire:
// :warning-caption: :warning:
// endif::[]

// // See https://gist.github.com/dcode/0cfbf2699a1fe9b46ff04c41721dda74#images
// ifdef::env-github[]
// :imagesdir: https://raw.githubusercontent.com/kwk/buildbot-app/main/
// endif::[]

// toc::[]
Let’s build an app that lets you control your buildbot through
`/buildbot` comments on Github Pull Requests.

image:docs/media/logo/logo-round-small.png[logo round small]

[[_scenarios]]
== Scenarios

This section lists the ideas and sometimes even fully implemented
scenarios we have for this GitHub app.

[[_comment_buildbot_on_pull_request]]
=== Comment `/buildbot` on Pull Request

In this scenario a user authors a Pull Request comment with the comment
body being `/buildbot`.

image::docs/media/screenshots/author-buildbot-comment.png[User authors
/buildbot comment]

The `buildbot-app` gets notified about a new comment and checks if it
matches a regular expression. In this case the pattern is `^/buildbot$`
but it could be much more complex and equipped with arguments, depending
on the semantics we want to establish. For the purpose of this
demonstration, `/buildbot` is simply enough.

[[_build_log_comment]]
==== Build Log Comment

The `buildbot-app` then creates a *Thank-you*-comment that serves two
purposes:

[arabic]
. It shows the user that we understood the request and are thankful for
it and that we are working on it.
. It is a perfect placeholder to store short build state changes for
future lookups. That is why we call this comment the
*build-log-comment*.
+
image::docs/media/screenshots/build-log-comment.png[A build-log-comment
example]
+
Just imagine, your PR gets updated and you want to see the previous
build results. The _build-log-comment_ is there for you too look it up.

[[_check_run]]
==== Check run

Of course, we are also using GitHub’s check runs as you can see here:

image::docs/media/screenshots/check-run-overview.png[A check run
overview]

[NOTE]
====
I really like that we can dynamically create check runs on request and
give them good names.
====

When you click on *Details* next to a check run, you’re brought to this
page on GitHub:

image::docs/media/screenshots/check-run-details.png[A details page of a
check run]

[[_video_walkthrough]]
==== Video walkthrough

We walk you through the creation of a Pull Request and authoring the
`/buildbot` comment in this in this short video:
https://www.youtube.com/watch?v=9NpbKEmkvt8

[[_uml_sequence_diagram]]
==== UML sequence diagram

The sequence diagram for this scenario is layed out here. It includes
some of the internals of the processing.

image::docs/media/on-buildbot-comment.svg[Sequence diagram for
on-buildbot-comment scenario]

[[_todos]]
==== TODOs

* ❏ Reset check run to neutral after Pull Request was updated.
* ❏ Deal with buttons shown at the top of check run details page.

[[_developer_setup]]
== Developer Setup

I’m using a Fedora Linux 37 on my local machine and for most of the
containers.

[source,console]
----
$ git clone https://github.com/kwk/buildbot-app.git && cd buildbot-app 
$ sudo dnf install -y direnv golang podman podman-compose buildbot pandic asciidoctor 
$ go install github.com/cespare/reflex@latest 
$ cat <<EOF >> ~/.bashrc 
export PATH=\${PATH}:~/go/bin
eval "\$(direnv hook bash)"
EOF
$ source ~/.bashrc 
$ direnv allow . 
$ make infra-start 
$ make app 
----

* Clone the repo.
* Install tools we need/use for development locally. If this was a
deployment site the only requirement is buildbot so that the github app
can make a call to `buildbot try`.
* Install hot-reload tool.
* Make tools above available upon next source of `.bashrc`.
* Reload `.bashrc` to have `direnv` and `reflex` working in your current
shell.
* Navgigate out and back into the project directory to have `direnv`
kickin. If this doesn’t work, try `direnv allow .`.
* Bring up local containers for a buildbot setup with one master and
three workers.
* Run and hot reload the app code upon changes being made to any of your
`*.go` files or your `.envrc` file.

[[_useful_links]]
== Useful links

[[_llvm_links]]
=== LLVM links

* Discussion on LLVM Discourse:
https://discourse.llvm.org/t/rfc-prototyping-pre-commit-testing-using-buildbot/69900?u=kwk

[[_github_app_documents]]
=== Github App documents

* Github Webhook Events and Payloads:
https://docs.github.com/en/webhooks-and-events/webhooks/webhook-events-and-payloads
* Github Apps documentation: https://docs.github.com/en/apps

[[_interacting_with_github]]
=== Interacting with Github

* Forwarding Github Webhooks to your local dev machine:
https://dashboard.ngrok.com/get-started/setup
* Github Emoji Cheat Sheet:
https://github.com/ikatyang/emoji-cheat-sheet/blob/master/README.md

[[_golang_libraries]]
=== Golang libraries

* For using Github API v3 from Golang:
https://github.com/google/go-github
* GraphQL Go Library for Github API v4:
https://github.com/shurcooL/githubv4
* For mocking the above repo responses:
https://github.com/migueleliasweb/go-github-mock
* Go web framework: https://github.com/labstack/echo
* For handling github events: https://github.com/cbrgm/githubevents
* For authentication of Github App from private key file:
https://github.com/bradleyfalzon/ghinstallation

[[_buildbot_links]]
== Buildbot links

* System Architecture:
https://docs.buildbot.net/latest/manual/introduction.html#system-architecture
* Custom services (Might be worth looking into):
https://docs.buildbot.net/latest/manual/configuration/services/index.html

[[_misc_links]]
=== Misc links

* Recording terminal sessions: https://github.com/faressoft/terminalizer
* For automatic reloading: https://github.com/cespare/reflex
* Per-Directory environment files: https://direnv.net/

[[_todo]]
== TODO

* ❏ properly document developer setup with ngrok and how to setup the
`.envrc` file
* ❏ hook into buildbots event system and send feedback to buildbot app
from there?
